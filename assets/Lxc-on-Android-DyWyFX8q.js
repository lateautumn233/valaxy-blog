import{_ as d}from"./ValaxyMain.vue_vue_type_style_index_0_lang-C6iFaOKN.js";import{a as p,p as o,o as k,c as u,w as e,f as g,q as _,r as l,g as s,h as a}from"./app-DJXMUuPO.js";import"./YunFooter.vue_vue_type_script_setup_true_lang-Cm-I7XME.js";import"./YunCard.vue_vue_type_script_setup_true_lang-CC1xuBOh.js";import"./YunPageHeader.vue_vue_type_script_setup_true_lang-D34gyHKd.js";import"./index-C7yU5XnD.js";const m=s("h1",{id:"android原生运行lxc",tabindex:"-1"},[a("Android原生运行Lxc "),s("a",{class:"header-anchor",href:"#android原生运行lxc","aria-label":'Permalink to "Android原生运行Lxc"'},"​")],-1),f=s("p",null,[s("img",{src:"https://999-1257394446.cos.ap-hongkong.myqcloud.com/img/images.png",alt:"image.png"}),a(" 简介："),s("br"),a(" LXC是一种操作系统层虚拟化技术，为Linux内核容器功能的一个用户空间接口。它将应用软件系统打包成一个软件容器，内含应用软件本身的代码，以及所需要的操作系统核心和库。")],-1),F=s("hr",null,null,-1),y=s("h1",{id:"_1-编译内核",tabindex:"-1"},[a("1. 编译内核 "),s("a",{class:"header-anchor",href:"#_1-编译内核","aria-label":'Permalink to "1. 编译内核"'},"​")],-1),b=s("h3",{id:"_1-1-调整内核配置",tabindex:"-1"},[a("1.1. 调整内核配置 "),s("a",{class:"header-anchor",href:"#_1-1-调整内核配置","aria-label":'Permalink to "1.1. 调整内核配置"'},"​")],-1),v=s("p",null,[a("使用此"),s("a",{href:"https://github.com/lateautumn233/android_kernel_docker",target:"_blank",rel:"noreferrer"},"仓库"),a("快捷添加配置")],-1),C=s("div",{class:"language-shell vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"shell"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"git"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," fetch https://github.com/lateautumn233/android_kernel_docker main")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"git"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," merge -s ours --no-commit --allow-unrelated-histories --squash FETCH_HEAD")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"git"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," read-tree --prefix=docker -u FETCH_HEAD")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"echo"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "source '),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},'\\"'),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"docker/Kconfig"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},'\\"'),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," >>"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," arch/arm64/Kconfig")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"git"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' commit -a -m "Imported docker/ from https://github.com/lateautumn233/android_kernel_docker"')])])]),s("button",{class:"collapse"})],-1),x=s("p",null,"然后再自行编译 🥵🥵🥵",-1),B=s("h3",{id:"_1-2-内核补丁",tabindex:"-1"},[a("1.2. 内核补丁 "),s("a",{class:"header-anchor",href:"#_1-2-内核补丁","aria-label":'Permalink to "1.2. 内核补丁"'},"​")],-1),E=s("p",null,"1.修复可能存在的panic情况",-1),A=s("ul",null,[s("li",null,[s("a",{href:"https://github.com/lateautumn233/android_kernel_oneplus_sm8250/commit/51656fb1d02cbad23208391d1ba052a46d5eacf5",target:"_blank",rel:"noreferrer"},"net/netfilter/xt_qtaguid.c")])],-1),D=s("div",{class:"language-patch vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"patch"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",null,"--- orig/net/netfilter/xt_qtaguid.c     2020-05-12 12:13:14.000000000 +0300")]),a(`
`),s("span",{class:"line"},[s("span",null,"+++ my/net/netfilter/xt_qtaguid.c       2019-09-15 23:56:45.000000000 +0300")]),a(`
`),s("span",{class:"line"},[s("span",null,"@@ -737,7 +737,7 @@")]),a(`
`),s("span",{class:"line"},[s("span",null,"{")]),a(`
`),s("span",{class:"line"},[s("span",null,"        struct proc_iface_stat_fmt_info *p = m->private;")]),a(`
`),s("span",{class:"line"},[s("span",null,"        struct iface_stat *iface_entry;")]),a(`
`),s("span",{class:"line"},[s("span",null,"-       struct rtnl_link_stats64 dev_stats, *stats;")]),a(`
`),s("span",{class:"line"},[s("span",null,"+       struct rtnl_link_stats64 *stats;")]),a(`
`),s("span",{class:"line"},[s("span",null,"        struct rtnl_link_stats64 no_dev_stats = {0};  ")]),a(`
`),s("span",{class:"line"},[s("span",null,"@@ -745,13 +745,8 @@")]),a(`
`),s("span",{class:"line"},[s("span",null,"        current->pid, current->tgid, from_kuid(&init_user_ns, current_fsuid()));")]),a(`
`),s("span",{class:"line"},[s("span",null,"        iface_entry = list_entry(v, struct iface_stat, list);")]),a(`
`),s("span",{class:"line"},[s("span",null,"+       stats = &no_dev_stats; ")]),a(`
`),s("span",{class:"line"},[s("span",null,"-       if (iface_entry->active) {")]),a(`
`),s("span",{class:"line"},[s("span",null,"-               stats = dev_get_stats(iface_entry->net_dev,")]),a(`
`),s("span",{class:"line"},[s("span",null,"-                                     &dev_stats);")]),a(`
`),s("span",{class:"line"},[s("span",null,"-       } else {")]),a(`
`),s("span",{class:"line"},[s("span",null,"-               stats = &no_dev_stats;")]),a(`
`),s("span",{class:"line"},[s("span",null,"-       }")]),a(`
`),s("span",{class:"line"},[s("span",null,"        /*")]),a(`
`),s("span",{class:"line"},[s("span",null,"         * If the meaning of the data changes, then update the fmtX")]),a(`
`),s("span",{class:"line"},[s("span",null,"         * string.")])])]),s("button",{class:"collapse"})],-1),P=s("p",null,"2.修复cgroup缺少cpuset前缀",-1),L=s("ul",null,[s("li",null,[s("a",{href:"https://github.com/lateautumn233/android_kernel_oneplus_sm8250/commit/14b4f8f5198071c5c6ec8146b4f4d99c9dc5135b",target:"_blank",rel:"noreferrer"},"kernel/cgroup/cgroup.c")])],-1),O=s("div",{class:"language-patch vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"patch"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",null,"--- a/kernel/cgroup/cgroup.c")]),a(`
`),s("span",{class:"line"},[s("span",null,"+++ b/kernel/cgroup/cgroup.c")]),a(`
`),s("span",{class:"line"},[s("span",null,"@@ -3786,6 +3786,10 @@ static int cgroup_add_file(struct cgroup_subsys_state *css, struct cgroup *cgrp,")]),a(`
`),s("span",{class:"line"},[s("span",null," 		cfile->kn = kn;")]),a(`
`),s("span",{class:"line"},[s("span",null," 		spin_unlock_irq(&cgroup_file_kn_lock);")]),a(`
`),s("span",{class:"line"},[s("span",null," 	}")]),a(`
`),s("span",{class:"line"},[s("span",null,"+	if (cft->ss && (cgrp->root->flags & CGRP_ROOT_NOPREFIX) && !(cft->flags & CFTYPE_NO_PREFIX)) {")]),a(`
`),s("span",{class:"line"},[s("span",null,'+				snprintf(name, CGROUP_FILE_NAME_MAX, "%s.%s", cft->ss->name, cft->name);')]),a(`
`),s("span",{class:"line"},[s("span",null,"+				kernfs_create_link(cgrp->kn, name, kn);")]),a(`
`),s("span",{class:"line"},[s("span",null,"+	}")]),a(`
`),s("span",{class:"line"},[s("span",null," ")]),a(`
`),s("span",{class:"line"},[s("span",null," 	return 0;")]),a(`
`),s("span",{class:"line"},[s("span",null," }")])])]),s("button",{class:"collapse"})],-1),w=s("p",null,"3.禁用ANDROID_PARANOID_NETWORK",-1),N=s("div",{class:"language-shell vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"shell"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"scripts/config"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --file"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," arch/arm64/configs/"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"defconfi"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"g"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," -")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"d"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ANDROID_PARANOID_NETWORK")])])]),s("button",{class:"collapse"})],-1),$=s("h3",{id:"_1-3-检查内核配置",tabindex:"-1"},[a("1.3. 检查内核配置 "),s("a",{class:"header-anchor",href:"#_1-3-检查内核配置","aria-label":'Permalink to "1.3. 检查内核配置"'},"​")],-1),R=s("p",null,"生成完整内核配置后检查",-1),T=s("div",{class:"language-shell vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"shell"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"wget"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," https://raw.githubusercontent.com/lxc/lxc/main/src/lxc/cmd/lxc-checkconfig.in -O lxc-checkconfig")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"chmod"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," a+x lxc-checkconfig")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"CONFIG"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"out/.config lxc-checkconfig")])])]),s("button",{class:"collapse"})],-1),I=s("p",null,[a("具体编译内核 "),s("br"),a(" 以下省略n字")],-1),q=s("h1",{id:"_2-安装lxc模块",tabindex:"-1"},[a("2. 安装lxc模块 "),s("a",{class:"header-anchor",href:"#_2-安装lxc模块","aria-label":'Permalink to "2. 安装lxc模块"'},"​")],-1),X=s("p",null,[a("下载此"),s("a",{href:"https://qiuqiu233.top/d/linux-deploy/lxc/LxcMagisk.zip",target:"_blank",rel:"noreferrer"},"magisk模块"),a("安装并重启")],-1),H=s("h3",{id:"_2-1-启动lxc容器",tabindex:"-1"},[a("2.1. 启动lxc容器 "),s("a",{class:"header-anchor",href:"#_2-1-启动lxc容器","aria-label":'Permalink to "2.1. 启动lxc容器"'},"​")],-1),K=s("p",null,"随便找一个终端软件执行",-1),M=s("div",{class:"language-shell vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"shell"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"."),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /data/lxc/env.sh")])])]),s("button",{class:"collapse"})],-1),S=s("p",null,"创建容器",-1),V=s("div",{class:"language-shell vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"shell"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"lxc-create"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -t"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," download -n my-container -- --server mirrors.tuna.tsinghua.edu.cn/lxc-images")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 依次填入发行版 版本号 架构")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 然后启动")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"lxc-start"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -n"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," my-container -d -F")])])]),s("button",{class:"collapse"})],-1),Z=s("p",null,"调整lxc容器密码",-1),G=s("div",{class:"language-shell vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"shell"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"chroot"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," path /bin/su -")]),a(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"lxc-attach"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -n"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," my-container passwd")])])]),s("button",{class:"collapse"})],-1),U=s("h2",{id:"_2-1-配置网络",tabindex:"-1"},[a("2.1. 配置网络 "),s("a",{class:"header-anchor",href:"#_2-1-配置网络","aria-label":'Permalink to "2.1. 配置网络"'},"​")],-1),W=s("p",null,"(可选，默认veth 可以不修改)",-1),j=s("h3",{id:"_2-1-1-使用host模式",tabindex:"-1"},[a("2.1.1 使用host模式 "),s("a",{class:"header-anchor",href:"#_2-1-1-使用host模式","aria-label":'Permalink to "2.1.1 使用host模式"'},"​")],-1),z=s("div",{class:"language-shell vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"shell"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sed"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -i"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 's/lxc\\.net\\.0\\.type = veth/lxc.net.0.type = none/g'"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /data/lxc/etc/lxc/default.conf")])])]),s("button",{class:"collapse"})],-1),J=s("p",null,"喵喵喵喵喵",-1),Y=s("h2",{id:"参考文章",tabindex:"-1"},[a("参考文章: "),s("a",{class:"header-anchor",href:"#参考文章","aria-label":'Permalink to "参考文章:"'},"​")],-1),Q=s("ul",null,[s("li",null,[s("a",{href:"https://gist.github.com/FreddieOliveira/efe850df7ff3951cb62d74bd770dce27",target:"_blank",rel:"noreferrer"},"Docker on Android")]),s("li",null,[s("a",{href:"https://mirrors.tuna.tsinghua.edu.cn/help/lxc-images/",target:"_blank",rel:"noreferrer"},"LXC Images 软件仓库镜像使用帮助")]),s("li",null,[s("a",{href:"https://github.com/lxc/lxc/issues/4072",target:"_blank",rel:"noreferrer"},"Failed to mount cgroup at /sys/fs/cgroup/systemd: Operation not permitted")]),s("li",null,[s("a",{href:"https://www.cnblogs.com/embedded-linux/p/10540426.html",target:"_blank",rel:"noreferrer"},"采用systemd-networkd管理网卡")]),s("li",null,[s("a",{href:"https://unix.stackexchange.com/questions/442598/how-to-configure-systemd-resolved-and-systemd-networkd-to-use-local-dns-server-f",target:"_blank",rel:"noreferrer"},"How to configure systemd-resolved and systemd-networkd to use local DNS server for resolving local domains and remote DNS server for remote domains?")])],-1),ss=s("p",null,[s("a",{href:"./"})],-1),hs={__name:"Lxc-on-Android",setup(as,{expose:c}){const i=JSON.parse('{"title":"Android原生运行Lxc","description":"","frontmatter":{"tags":["Linux"],"title":"Android原生运行Lxc","sources":["xlog"],"summary":"","attributes":[{"value":"Android-yuan-sheng-yun-xing-Lxcmd","trait_type":"xlog_slug"},{"value":false,"trait_type":"xlog_disable_ai_summary"}],"date":"2023-09-03T05:59:49.873Z","categories":["容器"],"modified":"2024-02-17T10:49:50.000Z"},"headers":[{"level":3,"title":"1.1. 调整内核配置","slug":"_1-1-调整内核配置","link":"#_1-1-调整内核配置","children":[]},{"level":3,"title":"1.2. 内核补丁","slug":"_1-2-内核补丁","link":"#_1-2-内核补丁","children":[]},{"level":3,"title":"1.3. 检查内核配置","slug":"_1-3-检查内核配置","link":"#_1-3-检查内核配置","children":[]},{"level":3,"title":"2.1. 启动lxc容器","slug":"_2-1-启动lxc容器","link":"#_2-1-启动lxc容器","children":[]},{"level":2,"title":"2.1. 配置网络","slug":"_2-1-配置网络","link":"#_2-1-配置网络","children":[{"level":3,"title":"2.1.1 使用host模式","slug":"_2-1-1-使用host模式","link":"#_2-1-1-使用host模式","children":[]}]},{"level":2,"title":"参考文章:","slug":"参考文章","link":"#参考文章","children":[]}],"relativePath":"pages/posts/Lxc-on-Android.md","path":"/home/runner/work/valaxy-blog/valaxy-blog/pages/posts/Lxc-on-Android.md","lastUpdated":1708336498000}'),r=p(),n=i.frontmatter||{};return r.meta.frontmatter=Object.assign(r.meta.frontmatter||{},i.frontmatter||{}),o("pageData",i),o("valaxy:frontmatter",n),globalThis.$frontmatter=n,c({frontmatter:{tags:["Linux"],title:"Android原生运行Lxc",sources:["xlog"],summary:"",attributes:[{value:"Android-yuan-sheng-yun-xing-Lxcmd",trait_type:"xlog_slug"},{value:!1,trait_type:"xlog_disable_ai_summary"}],date:"2023-09-03T05:59:49.873Z",categories:["容器"],modified:"2024-02-17T10:49:50.000Z"}}),(t,ts)=>{const h=d;return k(),u(h,{frontmatter:g(n)},{"main-content-md":e(()=>[m,f,_(" more "),F,y,b,v,C,x,B,E,A,D,P,L,O,w,N,$,R,T,I,q,X,H,K,M,S,V,Z,G,U,W,j,z,J,Y,Q,ss]),"main-header":e(()=>[l(t.$slots,"main-header")]),"main-header-after":e(()=>[l(t.$slots,"main-header-after")]),"main-nav":e(()=>[l(t.$slots,"main-nav")]),"main-content":e(()=>[l(t.$slots,"main-content")]),"main-content-after":e(()=>[l(t.$slots,"main-content-after")]),"main-nav-before":e(()=>[l(t.$slots,"main-nav-before")]),"main-nav-after":e(()=>[l(t.$slots,"main-nav-after")]),comment:e(()=>[l(t.$slots,"comment")]),footer:e(()=>[l(t.$slots,"footer")]),aside:e(()=>[l(t.$slots,"aside")]),"aside-custom":e(()=>[l(t.$slots,"aside-custom")]),default:e(()=>[l(t.$slots,"default")]),_:3},8,["frontmatter"])}}};export{hs as default};
